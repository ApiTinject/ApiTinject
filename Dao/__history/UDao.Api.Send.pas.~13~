unit UDao.Api.Send;

interface
uses System.SysUtils,
           System.JSON,

     System.StrUtils,
     DataSet.Serialize, FireDAC.Comp.Client,UWhats.account,UController.Comum;

  type
  TSendApi = class
  private
    FConexao: TFDConnection;
    FChamado: Integer;
    FTelefone: string;
    FMensagem: string;
    FAnexo: string;
    procedure SetTelefone(const Value: string);
    procedure SetMensagem(const Value: string);
    procedure SetAnexo(const Value: string);

  public
    constructor Create();
    destructor destroy; override;
    property Telefone: string read FTelefone write SetTelefone;
    property Mensagem: string read FMensagem write SetMensagem;
    property Anexo: string read FAnexo write SetAnexo;
    function Send(out erro: string;pTelefone,pMsg: string): string;
    function SendFile(out erro: string;pTelefone,pMsg,pAnexo: string): string;


  end;
implementation

{ TChamadosApi }

uses UServer;

constructor TSendApi.Create();
begin

end;

destructor TSendApi.destroy;
begin
  inherited;
end;



function TSendApi.Send(out erro: string; ptelefone,pMsg: string): string;
var
 pRetornoJson : TJsonObject;
begin
  pRetornoJson := nil;
  pRetornoJson := TJsonObject.Create;
  try

    if FServer.whats.Conectado then
    begin

      FServer.whats.SendMessage('123', pTelefone, pMsg);
      pRetornoJson.AddPair('status', 'OK');
      pRetornoJson.AddPair('mensagen', pMsg);
      pRetornoJson.AddPair('Enviado para o numero', pTelefone);
    end
    else
    begin
      pRetornoJson.AddPair('status', 'Não');
      pRetornoJson.AddPair('mensagen', 'Favor aguardar conexão');
    end;
    Result := pRetornoJson.ToString;
  finally
    if (pRetornoJson <> nil) then
    FreeAndNil(pRetornoJson);
  end;

end;

function TSendApi.SendFile(out erro: string; pTelefone, pMsg,
  pAnexo: string): string;
var
 pRetornoJson : TJsonObject;
begin
    pRetornoJson := nil;
    pRetornoJson := TJsonObject.Create;
   try
    if FServer.whats.Conectado then
 begin
   FServer.whats.SendMessage(
    '123',
    pTelefone,
    pMsg,
    TWFile.new.LoadFromFile(pAnexo)
  );
      pRetornoJson.AddPair('status', 'OK');
      pRetornoJson.AddPair('mensagen', pMsg);
      pRetornoJson.AddPair('arquivo', pAnexo);
      pRetornoJson.AddPair('Enviado para o numero', pTelefone);
   end
   else
   begin
      pRetornoJson.AddPair('status', 'Não');
      pRetornoJson.AddPair('mensagen', 'Favor aguardar conexão');
   end;
      Result := pRetornoJson.ToString;
  finally
  if (pRetornoJson <> nil) then
     FreeAndNil(pRetornoJson);
end;
end;

procedure TSendApi.SetAnexo(const Value: string);
begin
  FAnexo := Value;
end;

procedure TSendApi.SetMensagem(const Value: string);
begin
  FMensagem := Value;
end;

procedure TSendApi.SetTelefone(const Value: string);
begin
  FTelefone := Value;
end;

end.
